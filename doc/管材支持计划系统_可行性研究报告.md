# 管材支持计划系统 — 可行性研究报告

## 一、项目概述

### 1.1 项目目标

开发一套**自动化管材支持计划与物流规划系统**，通过读取 **CAD 图纸**和**报价信息**，自动生成：
- **管材支持计划**（Pipes Supporting Plan）：识别图纸中的管道需求，匹配管材规格与数量，生成采购/供应计划
- **物流计划**（Logistics Plan）：基于管材清单、供应商位置、项目地点，生成运输、仓储、配送方案

### 1.2 核心价值

| 价值点 | 说明 |
|--------|------|
| **自动化** | 减少人工从 CAD 图纸提取管道信息、手工匹配管材、计算物流成本的时间 |
| **准确性** | AI 识别管道规格、连接方式、数量，减少人工错误 |
| **效率** | 从图纸到计划的时间从数天缩短至数小时 |
| **成本优化** | 自动匹配最优供应商、计算物流路径，降低采购与运输成本 |

---

## 二、系统架构与技术方案

### 2.1 数据流

```
CAD 图纸（DWG/DXF）
    ↓
CAD 解析 Agent → 管道清单（规格、数量、位置）
    ↓
报价信息（Excel/JSON）
    ↓
报价解析 Agent → 供应商、价格、库存
    ↓
管材匹配 Agent → 管材支持计划（产品编号、数量、供应商）
    ↓
物流规划 Agent → 物流计划（运输路线、仓储、配送时间）
    ↓
输出：Excel 报告（支持计划 + 物流计划）
```

### 2.2 核心功能模块

| 模块 | 功能 | 输入 | 输出 |
|------|------|------|------|
| **CAD 解析** | 识别管道、管件、规格、数量 | DWG/DXF 文件 | JSON：管道清单 |
| **报价解析** | 提取供应商、价格、库存、物流信息 | Excel/JSON | JSON：报价数据 |
| **管材匹配** | 匹配管材库、计算需求、选择供应商 | 管道清单 + 报价数据 | JSON：支持计划 |
| **物流规划** | 计算运输路线、仓储需求、配送时间 | 支持计划 + 项目地点 | JSON：物流计划 |
| **报告生成** | 生成 Excel 报告 | 支持计划 + 物流计划 | Excel 文件 |

---

## 三、所需软件与工具

### 3.1 CAD 解析软件

| 软件/库 | 用途 | 许可证 | 成本估算 |
|---------|------|--------|----------|
| **ezdxf** | Python 库，解析 DXF 文件（AutoCAD 格式） | MIT | 免费 |
| **python-dwg** / **dxfgrabber** | DWG/DXF 解析 | MIT / LGPL | 免费 |
| **Open Design Alliance (ODA)** | 商业 DWG 解析 SDK（如需高精度） | 商业许可 | $5,000-15,000/年 |
| **AutoCAD API**（可选） | 若需与 AutoCAD 集成 | 商业许可 | 需 AutoCAD 授权 |

**推荐方案**：优先使用 **ezdxf**（免费、Python 原生），若精度不足再考虑 ODA SDK。

### 3.2 AI/LLM 平台

| 平台 | 用途 | 成本估算 |
|------|------|----------|
| **OpenAI GPT-4o / GPT-4 Turbo** | CAD 解析 Agent、管材匹配 Agent、物流规划 Agent | $0.01-0.03/1K tokens（输入），$0.03-0.06/1K tokens（输出） |
| **智谱 GLM-4** | 国内替代方案，支持中文 | ¥0.1-0.3/1K tokens |
| **Claude 3.5 Sonnet** | 高质量推理，适合复杂匹配 | $3/1M tokens（输入），$15/1M tokens（输出） |
| **本地模型**（可选） | Qwen2.5 / Llama 3.1，需 GPU | GPU 服务器成本 |

**推荐方案**：
- **开发/测试**：OpenAI GPT-4o（API 灵活）
- **生产环境**：根据数据敏感性选择 OpenAI 或智谱 GLM-4（国内合规）

### 3.3 数据处理与存储

| 软件/库 | 用途 | 成本 |
|---------|------|------|
| **pandas** | Excel 解析、数据处理 | 免费 |
| **openpyxl** | Excel 读写 | 免费 |
| **PostgreSQL** / **MySQL** | 存储管材库、报价数据、历史计划 | 免费（开源）或云服务 $50-200/月 |
| **SQLite** | 轻量级存储（小规模） | 免费 |

### 3.4 物流规划工具

| 工具/库 | 用途 | 成本 |
|---------|------|------|
| **Google Maps API** / **高德地图 API** | 计算距离、路线、运输时间 | $0.005-0.01/次请求 |
| **OR-Tools**（Google） | 车辆路径优化（VRP）、仓储优化 | 免费 |
| **NetworkX** | 图算法（路径规划） | 免费 |

### 3.5 开发框架与基础设施

| 工具 | 用途 | 成本 |
|------|------|------|
| **Python 3.12+** | 主开发语言 | 免费 |
| **FastAPI** | API 服务 | 免费 |
| **Docker** | 容器化部署 | 免费 |
| **云服务器**（AWS/阿里云/腾讯云） | 运行服务 | $50-300/月（按配置） |

---

## 四、AI Agents 设计

### 4.1 CAD 解析 Agent

**职责**：从 CAD 图纸中提取管道信息

**工具**：
- `read_cad_file(file_path)`：读取 DWG/DXF
- `extract_pipe_entities()`：提取管道实体（LINE、POLYLINE、BLOCK）
- `parse_pipe_specs(entity)`：解析管道规格（DN、压力等级、材质）
- `count_pipe_quantities()`：统计数量
- `identify_pipe_fittings()`：识别管件（三通、弯头、阀门等）

**Prompt 策略**：
- 使用 **ReAct 范式**（思考 → 工具调用 → 观察 → 继续）
- 先识别图层（layer）、块（block），再解析管道属性
- 对模糊规格（如“DN25”vs“25mm”）做澄清或规则匹配

**参考**：可复用 version3 的 `execute_react` 框架，新增 CAD 解析工具。

### 4.2 报价解析 Agent

**职责**：从报价单中提取供应商、价格、库存、物流信息

**工具**：
- `read_quotation_excel(file_path)`：读取报价 Excel
- `extract_supplier_info()`：提取供应商名称、地址、联系方式
- `extract_price_data()`：提取产品编号、价格、库存
- `extract_logistics_info()`：提取运输方式、运费、配送时间

**参考**：可复用现有 `quotation_tracker` 的 Excel 解析逻辑（`ExcelReader`、`LLMParser`）。

### 4.3 管材匹配 Agent

**职责**：匹配管材库，生成支持计划

**工具**：
- `search_pipe_material(spec)`：在管材库中搜索匹配规格
- `get_inventory_by_code(code)`：查询库存（复用现有）
- `match_wanding_price(product_name, spec)`：匹配万鼎价格库（复用现有）
- `calculate_requirements(pipe_list)`：计算总需求（考虑损耗率）
- `select_supplier(material, suppliers)`：选择最优供应商（价格+库存+物流）

**Prompt 策略**：
- 优先精确匹配（DN、压力等级、材质）
- 规格模糊时做澄清或按规则映射（如“25”→“DN25”）
- 考虑多供应商备选方案

**参考**：可复用 version3 的 `match_wanding_price` 逻辑与库存工具。

### 4.4 物流规划 Agent

**职责**：生成运输、仓储、配送计划

**工具**：
- `get_project_location(project_id)`：获取项目地点
- `calculate_distance(origin, destination)`：计算距离（地图 API）
- `estimate_transport_time(distance, vehicle_type)`：估算运输时间
- `optimize_route(suppliers, project_location)`：优化路线（OR-Tools）
- `calculate_storage_needs(material_list)`：计算仓储需求
- `generate_delivery_schedule()`：生成配送时间表

**Prompt 策略**：
- 考虑供应商位置、项目地点、运输方式（陆运/海运）
- 优化批次配送（减少运输次数）
- 考虑仓储成本与时间窗口

---

## 五、预算估算

### 5.1 开发成本（一次性）

| 项目 | 说明 | 成本估算 |
|------|------|----------|
| **CAD 解析模块开发** | 基于 ezdxf，开发管道识别、规格解析逻辑 | 2-3 人月 × ¥30,000 = **¥60,000-90,000** |
| **AI Agents 开发** | 4 个 Agent（CAD解析、报价解析、管材匹配、物流规划） | 3-4 人月 × ¥30,000 = **¥90,000-120,000** |
| **系统集成与测试** | API、数据库、报告生成 | 1-2 人月 × ¥30,000 = **¥30,000-60,000** |
| **CAD 解析 SDK**（可选） | ODA SDK 商业许可（若免费方案不足） | **$5,000-15,000**（约 ¥35,000-105,000） |
| **小计** | | **¥180,000-375,000** |

### 5.2 软件许可与 API 成本（年度）

| 项目 | 说明 | 年度成本 |
|------|------|----------|
| **LLM API** | OpenAI GPT-4o（假设每月 1000 次请求，平均 5K tokens/次） | $600-1,800（约 ¥4,200-12,600） |
| **地图 API** | Google Maps / 高德（假设每月 500 次路线计算） | $30-60（约 ¥210-420） |
| **云服务器** | AWS/阿里云（2核4G，按需扩展） | $600-1,200（约 ¥4,200-8,400） |
| **数据库** | PostgreSQL 云服务（可选） | $600-1,200（约 ¥4,200-8,400） |
| **小计** | | **¥8,810-30,820/年** |

### 5.3 运维成本（年度）

| 项目 | 说明 | 年度成本 |
|------|------|----------|
| **系统维护** | Bug 修复、功能迭代（0.5 人月/季度） | 2 人月 × ¥30,000 = **¥60,000** |
| **技术支持** | 用户培训、问题解答（0.25 人月/季度） | 1 人月 × ¥30,000 = **¥30,000** |
| **小计** | | **¥90,000/年** |

### 5.4 总预算汇总

| 阶段 | 成本 |
|------|------|
| **开发阶段**（一次性） | ¥180,000-375,000 |
| **运营第一年** | ¥98,810-120,820 |
| **运营后续年度** | ¥98,810-120,820/年 |

**备注**：
- 若使用免费 CAD 解析方案（ezdxf），开发成本可降至 **¥180,000-270,000**
- LLM 成本随使用量变化，可按实际用量调整模型（如 GPT-3.5 更便宜）
- 若数据敏感需本地部署 LLM，需增加 GPU 服务器成本（约 ¥50,000-200,000/年）

---

## 六、技术风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| **CAD 格式多样性** | DWG/DXF 版本差异、自定义块、图层命名不规范 | ① 优先支持主流格式（AutoCAD 2018+）；② 用 LLM 做模糊匹配与澄清；③ 提供模板/规范文档 |
| **管道识别准确率** | 复杂图纸中管道与标注分离、规格信息缺失 | ① 多阶段识别（图层→实体→标注→关联）；② 人工审核环节；③ 持续训练与规则优化 |
| **管材匹配精度** | 规格映射模糊（如“25”vs“DN25”）、品牌差异 | ① 复用现有 `match_wanding_price` 的规格解析逻辑；② 建立同义词库；③ Agent 澄清机制 |
| **物流规划复杂度** | 多供应商、多批次、时间窗口约束 | ① 使用 OR-Tools 做优化；② 简化模型（先单供应商，再扩展）；③ 人工调整接口 |
| **LLM API 成本** | 大量图纸解析导致 token 消耗高 | ① 本地预处理（规则提取管道实体，LLM 只做规格解析）；② 缓存机制；③ 按需选择模型（简单任务用 GPT-3.5） |

---

## 七、实施建议

### 7.1 分阶段实施

| 阶段 | 目标 | 时间 | 预算 |
|------|------|------|------|
| **Phase 1：MVP** | CAD 解析（基础）+ 报价解析 + 简单匹配 | 2-3 个月 | ¥120,000-180,000 |
| **Phase 2：增强** | 管材匹配优化 + 物流规划基础版 | 1-2 个月 | ¥60,000-90,000 |
| **Phase 3：优化** | 多供应商优化、报告生成、用户界面 | 1-2 个月 | ¥30,000-60,000 |

### 7.2 技术选型建议

- **CAD 解析**：先试 **ezdxf**（免费），不足再考虑 ODA SDK
- **LLM**：开发用 OpenAI GPT-4o，生产按合规性选 OpenAI 或智谱 GLM-4
- **物流规划**：先用 **Google Maps API** + **OR-Tools**（免费），后续可接专业物流系统
- **架构**：复用 version3 的 Agent 框架（`execute_react`、工具注册、before/after 钩子）

### 7.3 与现有系统集成

- **复用现有工具**：
  - `match_wanding_price`（万鼎价格匹配）
  - `get_inventory_by_code`（库存查询）
  - `quotation_tracker` 的 Excel 解析逻辑
- **扩展 Agent 框架**：
  - 在 version3 基础上新增 CAD 解析工具
  - 新增物流规划 Agent
  - 统一工具注册与过滤机制（参考「工具变多时的处理」文档）

---

## 八、结论

### 8.1 可行性评估

| 维度 | 评估 | 说明 |
|------|------|------|
| **技术可行性** | ✅ **高** | CAD 解析、LLM Agent、物流规划均有成熟方案 |
| **成本可行性** | ✅ **中等** | 开发成本 ¥180,000-375,000，年度运营 ¥98,810-120,820，需评估 ROI |
| **时间可行性** | ✅ **可行** | MVP 2-3 个月，完整系统 4-6 个月 |
| **风险可控性** | ⚠️ **中等** | CAD 格式多样性、识别准确率需持续优化 |

### 8.2 建议

1. **先做 MVP**：聚焦核心流程（CAD → 管道清单 → 简单匹配 → 基础报告），验证价值后再扩展
2. **复用现有能力**：充分利用 version3 的 Agent 框架、价格匹配、库存查询
3. **分阶段投入**：先免费方案（ezdxf + GPT-4o API），验证后再考虑商业 SDK 或本地部署
4. **建立反馈循环**：人工审核环节 + 持续优化规则与模型，提升准确率

---

## 附录：参考文档

- `Agent Team version3/doc/OpenManus_agent借鉴.md`：工具变多时的处理、Agent 框架设计
- `Agent Team version2/doc/报价单询价填充流程设计.md`：报价解析与匹配逻辑
- `Agent Team version3/backend/core/single_agent/agent.py`：ReAct Agent 框架
- `Agent Team version3/backend/core/single_agent/tools.py`：工具注册与执行
