# Agent Team version3 项目结构规整方案

## 当前问题：多 Agent 心智模型的残留

本项目本质上只有**一个 ReAct Agent**（`backend/core/single_agent/agent.py`），其余全部是它的**工具实现**。但当前目录命名还在用多 Agent 时代的思维：

| 问题 | 体现 |
|------|------|
| `backend/agents/quote/`、`backend/agents/quote_sheet/` | 它们不是 Agent，是工具实现 |
| `backend/core/single_agent/` | Agent 被藏在 `core/` 里，暗示它只是"核心之一" |
| `inventory_agent/`、`quotation_tracker/` 散落根目录 | 与 backend 平级，关系不清晰 |
| `src/` 保留在根目录 | 是底层库，归属模糊 |

---

## 正确心智模型

```
一个 Agent
  └─ 调用若干 Tools
       └─ 每个 Tool 有自己的业务实现
```

- **Agent**：只有一个，负责 ReAct 主循环、工具分发、对话状态管理
- **Tools**：Agent 能做的事，每类能力是一个 tool 模块
- **Server**：对外暴露 Agent 的网络层（HTTP API + WebSocket Gateway）

---

## 目标结构

```
Agent Team version3/
├── backend/
│   ├── agent/               # ★ 唯一的 Agent
│   │   ├── agent.py         # ReAct 主循环（原 core/single_agent/agent.py）
│   │   ├── tools.py         # 工具分发（原 core/single_agent/tools.py）
│   │   └── session.py       # 对话状态（原 core/context_system/session_store.py）
│   │
│   ├── tools/               # Agent 的工具实现（业务能力层）
│   │   ├── inventory/       # 库存查询工具
│   │   │   ├── ...          # 原 inventory_agent/ 全部内容
│   │   │   └── lib/         # 原 src/（ACCURATE API、cache 等底层库）
│   │   ├── quotation/       # 报价单工具
│   │   │   ├── quote_tools.py       # 原 agents/quote/quote_tools.py
│   │   │   ├── flow_orchestrator.py # 原 agents/quote_sheet/flow_orchestrator.py
│   │   │   └── shortage_report.py   # 原 agents/quote_sheet/shortage_report.py
│   │   └── oos/             # 无货跟踪工具
│   │       └── ...          # 原 quotation_tracker/ 全部内容
│   │
│   └── server/              # 网络层（对外暴露 Agent）
│       ├── api/             # FastAPI HTTP 路由（原 api/）
│       └── gateway/         # WebSocket Gateway（原 ws_gateway/）
│
├── control-ui/              # 前端（不变）
├── data/                    # 数据文件（不变）
├── doc/                     # 文档（不变）
├── start.py                 # 入口（不变）
└── run_backend.py           # 入口（不变）
```

根目录**不再有**任何业务包（`inventory_agent/`、`quotation_tracker/`、`src/`、`models/`、`config.py` 均移入 backend）。

---

## 对比：改了什么 / 为什么

| 旧路径 | 新路径 | 理由 |
|--------|--------|------|
| `backend/core/single_agent/` | `backend/agent/` | Agent 是主角，不是"核心的一个子目录" |
| `backend/core/context_system/` | `backend/agent/session.py` | 会话状态是 Agent 的一部分，不需要独立包 |
| `backend/agents/quote/` | `backend/tools/quotation/` | 不是 Agent，是工具实现 |
| `backend/agents/quote_sheet/` | `backend/tools/quotation/`（合并） | 与 quote 同属报价能力，无需分包 |
| `inventory_agent/`（根） | `backend/tools/inventory/` | 归入 backend，明确是工具实现 |
| `src/`（根） | `backend/tools/inventory/lib/` | 是 inventory 工具的底层库 |
| `quotation_tracker/`（根） | `backend/tools/oos/` | 归入 backend，命名反映能力（oos = out-of-stock） |
| `backend/ws_gateway/` | `backend/server/gateway/` | 是网络层，不是业务层 |
| `backend/api/` | `backend/server/api/` | 同上 |
| 根目录 `config.py`、`models/` | 删除 | re-export 包层消除，直接引用 backend.tools.oos |

---

## 实施步骤

### Step 1：移动目录 + 更新 import

1. `inventory_agent/` → `backend/tools/inventory/`
2. `src/` → `backend/tools/inventory/lib/`（或直接平铺到 `inventory/` 下）
3. `quotation_tracker/` → `backend/tools/oos/`
4. `backend/agents/quote/` + `backend/agents/quote_sheet/` → `backend/tools/quotation/`
5. `backend/core/single_agent/` → `backend/agent/`
6. `backend/core/context_system/session_store.py` → `backend/agent/session.py`
7. `backend/ws_gateway/` → `backend/server/gateway/`
8. `backend/api/` → `backend/server/api/`

批量 import 替换规则：

```
from inventory_agent.         → from backend.tools.inventory.
from src.                     → from backend.tools.inventory.lib.
from quotation_tracker.       → from backend.tools.oos.
from backend.agents.quote.    → from backend.tools.quotation.
from backend.agents.quote_sheet. → from backend.tools.quotation.
from backend.core.single_agent.  → from backend.agent.
from backend.core.context_system.session_store → from backend.agent.session
from backend.ws_gateway.      → from backend.server.gateway.
from backend.api.             → from backend.server.api.
```

### Step 2：删除 re-export 层

- 删除根目录 `config.py`（原为 `from quotation_tracker.config import *`）
- 删除根目录 `models/`（原为 re-export quotation_tracker 的 models）
- 更新所有引用这两者的地方，直接指向 `backend.tools.oos.config` / `backend.tools.oos.models`

### Step 3：验证

```bash
# 以根目录为 PYTHONPATH
python run_backend.py          # 后端启动无报错
python cli_agent.py            # CLI 可对话
# 测试库存查询、报价流程、无货跟踪
```

---

## 小结

| 指标 | 当前 | 目标 |
|------|------|------|
| 业务包散落根目录 | 3 个（inventory_agent、quotation_tracker、src） | 0 个 |
| 误导性 `agents/` 目录 | 存在 | 删除 |
| Agent 层级 | 藏在 `core/single_agent/` | 直接是 `backend/agent/` |
| 能力包命名 | quote、quote_sheet、inventory_agent | tools/inventory、tools/quotation、tools/oos |
| `core/` 层 | 存在（包含 1 个 agent + 1 个 session） | 删除（agent 和 session 合并为 agent/） |
