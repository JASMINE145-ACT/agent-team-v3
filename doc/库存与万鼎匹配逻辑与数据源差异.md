# 库存与万鼎匹配逻辑与数据源差异

## 一、正常逻辑（当前设计）

1. **先万鼎 + LLM 选型，再按 code 查库存**  
   用户用中文/简写询价（如「32弯头」「32*20内丝三通」）时：  
   - 用 `match_wanding_price` 在万鼎价格库匹配 → 得到 single 或 needs_selection；  
   - 若多候选，用 `select_wanding_match`（LLM）从候选中选 1 个，得到 **code**；  
   - 用该 **code** 调 `get_inventory_by_code(code)` 查库存。

2. **已有 code 时**  
   可直接调 `get_inventory_by_code(code)` 查库存，无需再走万鼎/LLM。

3. **英文品名时**  
   可用 `search_inventory` 等 tool 直接按英文关键词查库存（更适配英文）。

---

## 二、数据源差异导致的问题

| 维度     | Accurate 系统（库存） | 万鼎数据库（价格） |
|----------|------------------------|---------------------|
| 语言     | **仅英文**             | **中文 + 英文**     |
| 库存     | **有**                 | 无（价格库）        |
| 价格     | **无**                 | **有**              |

**表现：**

- 库存结果来自 Accurate，只有英文品名、有库存/可售，**无价格**。  
- 价格、中文品名来自万鼎；匹配不到时（例如只查了「管材」sheet、弯头/三通在「配件」sheet），就出现「没有抓到」或无法给出价格。  
- 用户问「90度弯头带检查口 PVC 50 的库存」时：  
  - 可能万鼎无完全匹配（缺「带检查口」等规格），或命中的是相关品（90°弯头无检查口、或带检查口但不是弯头）；  
  - 库存侧按 code/英文查到的结果与万鼎品名、规格不完全一致，需要解释「无完全匹配，以下是相关产品」并说明差异（如：无检查口、非 90 度弯头等）。

---

## 三、建议与待办（当前双源下的补救）

- **万鼎**：确认价格库是否包含「管材」以外的 sheet（如「配件」），弯头、三通等是否在配件表；若在，匹配逻辑需同时查多 sheet 或按品类选 sheet。  
- **口径统一**：回复用户时区分「库存来源：Accurate（英文、无价）」「价格/中文名来源：万鼎」，避免混为一谈。  
- **无完全匹配时**：当前说明「没有找到完全匹配……以下是相关产品」并逐条解释差异（如截图中的说明），可保留并固化到回复模板。

---

## 四、最佳方案：Accurate 统一数据表（兼有所有）

**思路**：以 **Accurate 为唯一/主数据源**，或在其下游做**统一数据表**，使一张表（或一套 API）同时具备：

| 维度 | 统一表目标 |
|------|------------|
| 库存 | 有（来自 Accurate 或同步） |
| 价格 | 有（从万鼎或别源同步/关联进来） |
| 语言 | 中文 + 英文（品名、规格等） |
| 编码 | 统一 code（与库存、价格一一对应） |

**好处**：

- 不再需要「先万鼎 LLM 选型 → 再拿 code 查库存」的分步逻辑，一次查询即可得到库存 + 价格 + 中英文。
- 避免两套数据（Accurate 仅英文无价、万鼎有价有中文）口径不一致、匹配不到、解释复杂的问题。
- 工具链可简化为：按关键词/code 查统一表 → 直接返回库存 + 价格 + 品名（中英）。

**落地方式（可选）**：

- 在 Accurate 上扩展字段：同步万鼎价格、中文品名到 Accurate 主表或关联表；或  
- 建下游汇总库/视图：ETL 把 Accurate 库存与万鼎价格按 code 关联，产出「库存+价格+中英文」统一表，Agent 只查这张表。

当前在未做统一表之前，仍按第二节、第三节的双源逻辑与补救措施处理。

---

*记录时间：按需求整理。*
