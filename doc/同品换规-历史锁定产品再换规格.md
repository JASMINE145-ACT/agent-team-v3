# 同品换规：先锁定产品再替换规格

## 一、背景与问题

- **现状**：历史报价 + 万鼎并行。历史按「询价名称 A + 规格 B」在映射表里匹配；万鼎按名称/规格做字段匹配。  
- **场景**：用户问「**直接 dn60**」。历史里只报过「**直接 dn50**」，没有 dn60；但本质是**同一产品、不同规格**。  
- **思路**：先用历史**锁定产品**（直接 dn50 → 得到 code / 产品线），再按用户要的规格 **dn60** 做「同品换规」——用该 code 去万鼎查是否有 dn60 的价，或给出「同产品，可提供 dn60，价格 xxx」或「历史仅有 dn50，dn60 需向万鼎/供应商确认」。

---

## 二、目标

- 当**精确「A+B」历史无结果**（如 直接+dn60 无）但**产品名/类型有历史**（如 直接+dn50 有）时：  
  - 用历史**按产品锁定** code；  
  - 用**用户目标规格**（dn60）做「换规」：查万鼎该 code/同品是否有 dn60 价，或返回「同品换规」建议。

---

## 三、方案概述

| 步骤 | 内容 |
|------|------|
| 1. 产品级历史匹配（规格放宽） | 在现有「A+B」匹配之外，增加「仅按 A（或产品类型）匹配」得到「同产品」的 code 与历史规格（如 dn50）。 |
| 2. 规格替换 / 同品换规查询 | 用锁定的 code（或万鼎 Material） + **用户目标规格**（dn60）查万鼎：是否有 dn60 的价；若无则返回「同产品仅历史 dn50，dn60 需确认」或带历史 dn50 价格作参考。 |
| 3. 结果标识 | 结果标记来源为「同品换规」（与 历史报价/字段匹配/共同 并列），避免与精确历史匹配混淆。 |

---

## 四、触发条件（避免乱触发）

同品换规**不能**一见到「历史规格 ≠ 用户规格」就触发，否则会误把不同产品当同品。下面分「三层不触发判断」和「可写进代码的综合触发条件」。

### 4.1 三层判断（三档：何时不触发）

| 档位 | 条件 | 行为 |
|------|------|------|
| **1. 精确规格一致** | 从用户 query 解析出 `target_spec`（如 dn60）。若历史 A+B 顶层候选中有 `spec == target_spec`（或等价写法，如 60mm≈DN60） | **不触发换规**，按现有逻辑用该条即可。 |
| **2. 万鼎高置信度** | 万鼎字段匹配给出**非常干净**的结果：仅 1 条候选、分数远高于第二名、规格正好是 target_spec | **不触发换规**，尊重万鼎。仅当万鼎是「多条模糊候选 / 分数差距很小」时，才考虑用历史锁产品。 |
| **3. 仅「历史好、万鼎乱」时触发** | ① 历史 A+B 顶层候选的**底层产品名**（去掉规格）与用户 query 高度相似（如都是「直接」），但规格 ≠ target_spec；② 万鼎对 target_spec 的结果不干净（多候选、分数接近、规格混乱） | **同时满足**才执行「先锁产品（历史）→ 再换规格（万鼎）」的同品换规。 |

### 4.2 可写进代码的触发条件（具体输入与阈值）

**假设已有：**

- `query_product`：从用户 query 抽出的产品基名（如「直接」「弯头」）。
- `query_spec`：目标规格（如 dn60）。
- `history_candidates`：映射表 A+B 匹配列表，每项含 `name`, `spec`, `code`, `score` 等。
- `wanding_candidates`：万鼎字段匹配候选，每项含 `spec`, `score` 等。

**触发条件定义：**

1. **历史侧：产品高度稳定、规格不等于目标**
   - 取历史顶 1：`h0 = history_candidates[0]`。
   - 计算 `base(h0.name)` 与 `base(query_product)` 的相似度（去掉尺寸/压力，只比「直接/弯头/三通」等产品部分）。
   - 要求：`similarity >= 阈值`（如 0.9），且 `h0.spec != query_spec`（或规格未归一等价）。
   - 可选增强：若历史里**同一 base(name)** 出现过多种规格（50/60/90 等），说明该产品是「一条产品线多规格」，换规格更合理，可放宽触发或优先换规。

2. **万鼎侧：对目标规格没有「很干净」的答案**
   - 满足其一即视为不干净：
     - `wanding_candidates` 中与 `query_spec` 相关的候选**多条且分数差距 < 某阈值**（如前两名差 < 0.05）；或
     - 仅有**低分候选**（如整体 score < 某阈值）。
   - 含义：单靠字段匹配难以直接选出正确的 dn60，才用历史锁产品再换规。

3. **综合触发**
   - **仅当同时满足**：① 历史 base 很像、仅规格不同；② 万鼎对 target_spec 不够自信；  
   - 才执行「先锁产品（用历史 code）→ 再按 query_spec 查万鼎」的同品换规逻辑。

**阈值建议**：先取默认值（如相似度 0.9、万鼎分数差 0.05），再用离线样本打 log 观察触发是否合理，按需收紧或放宽。

---

## 五、实现要点

### 5.1 数据与现有逻辑

- **映射表**：`version3/data/整理产品(2).xlsx`，列 A=询价名称、B=规格、C=产品编号、D=报价名称。当前历史匹配为「A+B」模糊，取 top 候选。  
- **万鼎价格库**：按 Material（或 code）查价；若表结构支持「同一 Material 多规格」（如多行或 Size 列），则可实现「同 code + 目标规格」查询。

### 4.2 产品级匹配（规格放宽）

- **触发条件**：用户询价 keywords 解析出「产品名/类型」+「目标规格」（如 直接 + dn60）；现有「A+B」历史匹配无结果或结果置信度低。  
- **逻辑**：  
  - 在映射表中做**仅按 A（询价名称）或产品类型**的匹配（可忽略 B 或对 B 做宽松匹配），得到若干「同产品」记录，如 直接+dn50 → code。  
  - 取其中一条（或按历史使用频率取）得到 **锁定 code** 与 **历史规格**（dn50）。  
- **实现位置**：在现有 `match_mapping_top_candidates`（或封装它的历史匹配层）旁增加一档：  
  - 先做现有 A+B 匹配；  
  - 若无结果，再调「仅 A / 产品级」匹配，得到 code + 历史规格。

### 5.3 同品换规查询（万鼎）

- **输入**：锁定的 code（或由 code 反查的万鼎 Material）、用户目标规格（dn60）。  
- **逻辑**：  
  - **若万鼎支持「按 code/Material + 规格」查价**：直接查该产品 dn60 的价格；有则返回「同品换规」结果（产品名 + dn60 + 价格），来源标「同品换规」。  
  - **若万鼎仅有「按 code 查当前规格」**：用 code 查得当前价（如 dn50），再在万鼎表中查同 Material 下是否有 dn60 行；有则返回 dn60 价，无则返回「历史仅有 dn50，同产品 dn60 需向万鼎/供应商确认」，并可带 dn50 价格作参考。  
- **实现位置**：  
  - 若有现成 `get_wanding_price_by_code(code, spec?)` 或可按 Material+Size 查，则封装「同品换规」查询函数，供历史产品级匹配后调用。  
  - 若当前只有按 code 查单规格，需看万鼎表结构是否有多规格列或需扩展一次「同 Material 多规格」查询。

### 5.4 编排方式（推荐）

- **在 match_quotation / match_quotation_union 内部扩展**（推荐）：  
  - 先做现有「历史 A+B + 万鼎并行」；  
  - 若历史无候选且用户输入可解析出「产品 + 目标规格」，则：  
    - 调「产品级历史匹配」得 code；  
    - 调「同品换规」用 code + 目标规格查万鼎；  
    - 若有结果则并入 candidates，并标 `match_source: "同品换规"`。  
- **不强制新增单独工具**：同品换规作为现有 match 流程的一个分支，对前端/Agent 透明；若希望后续可单独调用，再拆成可选工具（如 `match_history_same_product_then_spec(user_spec)`）亦可。

### 5.5 规格解析

- 用户说「直接 dn60」「直接60」时，需从 query 中解析出**产品部分**（直接）与**目标规格**（dn60）。  
- 可与现有万鼎/选型里的规格归一复用（如 dn、英寸、主径×副径等），保证「目标规格」与万鼎表里的规格列一致，便于同品换规查询。

---

## 六、结果形态示例

| 场景 | 返回示例 |
|------|----------|
| 历史有 直接+dn50 → code；万鼎有该 code 的 dn60 价 | 一条候选：产品名、规格 dn60、价格 xxx，match_source=「同品换规」 |
| 历史有 直接+dn50 → code；万鼎无 dn60 | 提示「历史仅报过该产品 dn50；dn60 需向万鼎/供应商确认」，可选带 dn50 价格作参考 |
| 历史无「直接」任何规格 | 走现有逻辑，不进入同品换规 |

---

## 七、落地顺序建议

1. **确认万鼎表结构**：是否支持「同一 Material/code 多规格」查询；若支持，封装「按 code + 目标规格」查价函数。  
2. **实现产品级历史匹配**：在映射表上增加「仅 A 或产品类型」匹配，返回 code + 历史规格。  
3. **在 match 流程中接枝**：先实现**四、触发条件**，再在满足触发时执行产品级匹配 → 同品换规查询 → 结果标「同品换规」并入 candidates。  
4. **规格解析与归一**：从用户 query 拆出「产品」与「目标规格」，与万鼎规格写法对齐。  
5. **技能 prompt / 展示**：在「匹配来源」中增加「同品换规」说明，并约定展示时标明（与 历史报价/字段匹配/共同 并列）。

---

## 八、小结

- **思路**：历史先按**产品**锁定 code（规格放宽），再用**用户目标规格**做「同品换规」查万鼎；有则返回同品换规价，无则返回「需确认」+ 可选历史规格价参考。  
- **实现**：产品级历史匹配 + 万鼎「code + 目标规格」查询 + 在现有 match 流程中接枝并标 `match_source=同品换规`。  
- **不新增用户可见工具**也可完成；若需独立入口再考虑单独工具或参数（如 `relax_spec=True`）。
