# Agent Team version3 — 云端部署准备清单

部署到云平台（Render / Railway / Fly.io / 国内云等）前，按本清单逐项准备。

---

## 一、必做准备

### 1. 环境变量（云端只填环境变量，不要提交 .env）

在云平台的「环境变量 / Environment Variables」里配置，**不要**把 `.env` 提交到 Git：

| 变量 | 必填 | 说明 |
|------|:----:|------|
| `OPENAI_BASE_URL` | 是（智谱） | 如 `https://open.bigmodel.cn/api/paas/v4` |
| `ZHIPU_API_KEY` | 是（智谱） | 智谱 API Key；若用 OpenAI 则填 `OPENAI_API_KEY` 并改 `OPENAI_BASE_URL` |
| `AOL_ACCESS_TOKEN` | 是 | 库存查询（Accurate Online） |
| `AOL_SIGNATURE_SECRET` | 是 | |
| `AOL_DATABASE_ID` | 是 | |
| `API_HOST` | 否 | 默认 `0.0.0.0`（对外监听） |
| `API_PORT` 或 `PORT` | 否 | 默认 8000；多数云平台会注入 `PORT`，应用已兼容 |

### 2. 业务数据文件（询价/万鼎/报价单依赖）

以下文件若**未提交到 Git**，需在云端通过挂载卷或对象存储提供，并用环境变量指向路径：

- **万鼎价格库**：`data/万鼎价格库_管材与国标管件_标准格式.xlsx`  
  → 环境变量 `PRICE_LIBRARY_PATH` 指向实际路径（容器内路径）。
- **询价映射表**：`data/整理产品(2).xlsx`  
  → 环境变量 `MAPPING_TABLE_PATH`（库存子模块用，见 `backend/tools/inventory/config.py`）。
- **库存 Resolver 表**：`backend/tools/inventory/item-list-slim.xlsx`（及可选 `item-list-slim_embeddings.npy`）  
  → 环境变量 `INVENTORY_ITEM_LIST_SLIM_PATH` 若与默认路径不同则指定。

若这些文件**已提交到仓库**，则克隆/构建镜像后会自带，无需额外挂载。

### 3. 前端静态（必须存在，否则页面显示「前端未构建」）

- 仓库内应已包含构建好的 `dist/control-ui/`（含 `index.html`、`assets/`）。
- 若你删除了 `dist/` 或从未构建：在**项目根目录**执行  
  `cd control-ui && npm install && npm run build && cd ..`  
  再提交或打镜像，确保镜像/部署包里有 `dist/control-ui/`。

### 4. 端口与启动

- 应用监听 `0.0.0.0:API_PORT`，已支持云平台注入的 `PORT`（见 `backend/config.py`）。
- 启动命令（以项目根为工作目录）：  
  `pip install -r requirements.txt && python run_backend.py`  
  或直接用镜像时：`CMD ["python", "run_backend.py"]`（见根目录 `Dockerfile`）。

---

## 二、持久化（会话 / 上传 / 无货库）

云实例重启后本地盘通常清空，若需保留：

- **会话**：`SESSION_STORE_DIR` 默认 `data/sessions`。  
  → 用**持久卷**挂载到该路径（如 Docker volume、云盘）。
- **上传文件**：`UPLOAD_DIR` 默认 `uploads`。  
  → 同上，挂载持久卷。
- **无货库**：若使用无货登记，SQLite 默认在 `data/out_of_stock.db`（若存在）。  
  → 将 `data/` 或该文件所在目录挂载为持久卷；或后续改为外接 MySQL 等。

Serverless/无持久盘时：会话和上传会随实例回收丢失，仅适合演示或短期试用。

---

## 三、Docker 部署时

- 在**项目根目录**（与 `Dockerfile` 同级）执行：  
  `docker build -t agent-v3 .`  
  确保构建上下文包含 `dist/control-ui/`、`data/`（若业务文件在仓库内）、`backend/` 等。
- 运行示例（端口 + 环境变量，密钥用 `-e` 或 `--env-file`，不要写进镜像）：  
  `docker run -d -p 8000:8000 -e ZHIPU_API_KEY=xxx -e AOL_ACCESS_TOKEN=xxx ... agent-v3`  
  需持久化时加 `-v` 挂载 `data`、`uploads`。

---

## 四、安全与对外访问

- 应用本身只提供 HTTP；对外 HTTPS 由云平台反向代理/负载均衡配置。
- 对公网开放时，建议在反向代理层做认证（Basic Auth、OAuth 或统一登录），不要在前端或应用内硬编码密钥。

---

## 五、当前你需要「现在」做的事（小结）

1. **确认**：`.env` 未提交、云端只通过环境变量填密钥和可选路径。
2. **确认**：业务 Excel/数据文件要么在仓库内，要么在云端挂载并配好 `PRICE_LIBRARY_PATH`、`MAPPING_TABLE_PATH`、`INVENTORY_ITEM_LIST_SLIM_PATH`。
3. **确认**：`dist/control-ui/` 存在（本地有或构建后提交/打进镜像）。
4. **选择**：是否要持久化会话/上传 → 是则规划挂载卷与 `SESSION_STORE_DIR`、`UPLOAD_DIR`。
5. **选择**：用源码部署（平台自动 `pip install` + `python run_backend.py`）还是 Docker 部署（`docker build` + `docker run`），按平台文档填启动命令与端口。

更细的「部署到云端」步骤、平台推荐与注意事项见根目录 **README.md** 中「部署到云端」一节。
